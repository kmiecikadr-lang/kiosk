<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Admin</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,sans-serif;background:#f5f7fa}.login{display:flex;align-items:center;justify-content:center;height:100vh}.login-box{background:white;padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1);width:400px}.login-box h1{margin-bottom:20px;color:#667eea;text-align:center}input{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;margin-bottom:20px;font-size:1rem}button{width:100%;padding:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer}button:hover{opacity:.9}.hidden{display:none}.panel{padding:40px}.header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:30px;margin-bottom:40px}.section{margin-bottom:40px}.section-title{font-size:1.2rem;font-weight:700;color:#2d3748;margin-bottom:15px;padding-left:5px;border-left:4px solid #667eea}.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:20px}.card{background:white;padding:25px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}.card-title{font-size:.9rem;color:#718096;margin-bottom:10px}.card-value{font-size:2.5rem;font-weight:700}.actions{margin-top:20px;display:flex;gap:10px;flex-wrap:wrap}.actions button{width:auto;margin-right:10px;padding:10px 20px}.error{color:red;margin-bottom:10px}
</style>
</head>
<body>
<div id="loginView" class="login">
<div class="login-box">
<h1>ğŸ” Admin</h1>
<div id="error" class="error hidden"></div>
<input type="password" id="pass" placeholder="HasÅ‚o" autofocus>
<button onclick="login()">Zaloguj</button>
</div>
</div>
<div id="panelView" class="hidden">
<div class="header">
<h1>ğŸ“Š Panel</h1>
<div class="actions">
<button onclick="loadData()">ğŸ”„ OdÅ›wieÅ¼</button>
<button onclick="exportCSV()">ğŸ“¥ CSV</button>
<button onclick="exportExcel()">ğŸ“Š Excel z wykresem</button>
<button onclick="clearData()">ğŸ—‘ï¸ WyczyÅ›Ä‡</button>
<button onclick="logout()">Wyloguj</button>
</div>
</div>
<div class="panel">
<div class="section">
<div class="section-title">ğŸ“… Razem</div>
<div class="cards">
<div class="card"><div class="card-title">Wszystkie</div><div class="card-value" id="all-total">0</div></div>
<div class="card"><div class="card-title">ğŸ˜Š</div><div class="card-value" id="all-happy">0</div></div>
<div class="card"><div class="card-title">ğŸ˜</div><div class="card-value" id="all-neutral">0</div></div>
<div class="card"><div class="card-title">â˜¹ï¸</div><div class="card-value" id="all-sad">0</div></div>
</div>
</div>
<div class="section">
<div class="section-title">ğŸ“† Dzisiaj</div>
<div class="cards">
<div class="card"><div class="card-title">Wszystkie</div><div class="card-value" id="today-total">0</div></div>
<div class="card"><div class="card-title">ğŸ˜Š</div><div class="card-value" id="today-happy">0</div></div>
<div class="card"><div class="card-title">ğŸ˜</div><div class="card-value" id="today-neutral">0</div></div>
<div class="card"><div class="card-title">â˜¹ï¸</div><div class="card-value" id="today-sad">0</div></div>
</div>
</div>
<div class="section">
<div class="section-title">ğŸ“† Wczoraj</div>
<div class="cards">
<div class="card"><div class="card-title">Wszystkie</div><div class="card-value" id="yesterday-total">0</div></div>
<div class="card"><div class="card-title">ğŸ˜Š</div><div class="card-value" id="yesterday-happy">0</div></div>
<div class="card"><div class="card-title">ğŸ˜</div><div class="card-value" id="yesterday-neutral">0</div></div>
<div class="card"><div class="card-title">â˜¹ï¸</div><div class="card-value" id="yesterday-sad">0</div></div>
</div>
</div>
<div class="section">
<div class="section-title">ğŸ“† Przedwczoraj</div>
<div class="cards">
<div class="card"><div class="card-title">Wszystkie</div><div class="card-value" id="daybefore-total">0</div></div>
<div class="card"><div class="card-title">ğŸ˜Š</div><div class="card-value" id="daybefore-happy">0</div></div>
<div class="card"><div class="card-title">ğŸ˜</div><div class="card-value" id="daybefore-neutral">0</div></div>
<div class="card"><div class="card-title">â˜¹ï¸</div><div class="card-value" id="daybefore-sad">0</div></div>
</div>
</div>
</div>
</div>
<script>
let token=null;
function login(){
  const pass=document.getElementById('pass').value;
  fetch('/api/admin/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pass})})
  .then(r=>r.json())
  .then(d=>{
    if(d.success){
      token=pass;
      sessionStorage.setItem('token',pass);
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('panelView').classList.remove('hidden');
      loadData();
    }else{
      document.getElementById('error').textContent='ZÅ‚e hasÅ‚o';
      document.getElementById('error').classList.remove('hidden');
    }
  });
}

function loadData(){
  fetch('/api/admin/statistics',{headers:{'Authorization':'Bearer '+token}})
  .then(r=>r.json())
  .then(d=>{
    console.log('Received data:', d);
    
    const updateSection = (prefix, data) => {
      if (!data) {
        console.error('No data for', prefix);
        return;
      }
      document.getElementById(prefix+'-total').textContent = data.total || 0;
      const r = {1:0,2:0,3:0};
      if (data.reactions) {
        data.reactions.forEach(x => r[x.reaction] = x.count);
      }
      document.getElementById(prefix+'-happy').textContent = r[1];
      document.getElementById(prefix+'-neutral').textContent = r[2];
      document.getElementById(prefix+'-sad').textContent = r[3];
    };
    
    if (d.data) {
      updateSection('all', d.data.all);
      updateSection('today', d.data.today);
      updateSection('yesterday', d.data.yesterday);
      updateSection('daybefore', d.data.dayBefore);
    }
  })
  .catch(err => {
    console.error('Error loading data:', err);
  });
}

function exportCSV(){
  fetch('/api/admin/export.csv',{headers:{'Authorization':'Bearer '+token}})
  .then(r=>r.blob())
  .then(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='feedback.csv';
    a.click();
  });
}

function exportExcel(){
  fetch('/api/admin/export.xlsx',{headers:{'Authorization':'Bearer '+token}})
  .then(r=>r.blob())
  .then(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='feedback.xlsx';
    a.click();
  });
}

function clearData(){
  if(confirm('UsunÄ…Ä‡?')){
    fetch('/api/admin/clear',{method:'DELETE',headers:{'Authorization':'Bearer '+token}})
    .then(()=>{
      alert('OK');
      loadData();
    });
  }
}

function logout(){
  token=null;
  sessionStorage.removeItem('token');
  location.reload();
}

const saved=sessionStorage.getItem('token');
if(saved){
  token=saved;
  document.getElementById('loginView').classList.add('hidden');
  document.getElementById('panelView').classList.remove('hidden');
  loadData();
}

document.getElementById('pass').addEventListener('keypress',e=>{
  if(e.key==='Enter') login();
});
</script>
</body>
</html>
